!function(r){"use strict";r(document).ready(function(){var a=0,n=null;r.ajaxPrefilter(function(e,t,a){if(t.hasOwnProperty("data")&&t.data.hasOwnProperty("action")){var i=t.data.action;if("new_activity_comment"==i)0!=(n=r("#ac-form-"+t.data.form_id).find('input[name="attachments_files[]"]').map(function(e,t){return r(t).val()}).get()).length&&(e.data+="&attachments_files="+n,""==t.data.content&&(e.data+="&content={{{youzify_comment_attachment}}}"));else if("messages_send_reply"==i){var n;0!=(n=r("#send-reply").find('input[name="attachments_files[]"]').map(function(e,t){return r(t).val()}).get()).length&&(e.data+="&attachments_files="+n,""==t.data.content&&(e.data+="&content={{{youzify_message_attachment}}}"))}}}),r(document).ajaxSuccess(function(e,t,a){if("[object String]"==Object.prototype.toString.call(a.data)){var i=t.responseText;if(i[0]+i[1]!="-1"){var n=r.youzify_getUrlParameter(a.data,"action");"new_activity_comment"==n?(r("#ac-form-"+r.youzify_getUrlParameter(a.data,"form_id")).find(".youzify-delete-attachment").trigger("click"),r("#ac-form-"+r.youzify_getUrlParameter(a.data,"form_id")).find(".youzify-wall-upload-btn").fadeIn()):"messages_send_reply"==n&&(r("#send-reply").find(".youzify-delete-attachment").trigger("click"),r("#send-reply").find(".youzify-upload-btn").fadeIn())}}}),r(document).on("change",".youzify-upload-attachments",function(e){e.preventDefault();var t=r(this).closest("form");if(t.hasClass("ac-form")&&(t.find(".youzify-wall-upload-btn").fadeOut(),t.find(".youzify-attachment-item")[0]))return!1;var a=r(this).closest(".youzify-attachments"),i=a.find(".youzify-wall-item-upload");if(i[0]&&(i.fadeOut(1),a.find(".youzify-attachment-item")[0]))return!1;n=r(this).get(0),r.youzify_UploadFiles(t,a,{attachments:n})}),r.youzify_UploadFiles=function(e,t,a){for(var i=r.extend({},a).attachments.files,n=0;n<i.length;n++){var o=i[n];if(e.hasClass("youzify-wall-form")){if(!r.youzify_CheckFilesNumber(e))return!1}else if(e.find(".youzify-attachment-item")[0])return!1;var f=r.youzifyAttachmentItem({file:o,input_name:t.attr("data-name")?t.attr("data-name"):"attachments_files[]",file_name:o.name});e.hasClass("ac-form")?e.find(".youzify-wall-upload-btn").fadeOut(1):"send-reply"!=e.attr("id")&&"send_message_form"!=e.attr("id")||e.find(".youzify-upload-btn").fadeOut(1),t.find(".youzify-form-attachments").append(f),0==n&&r.youzify_UploadFile(e,t,o)}},r.youzifyAttachmentItem=function(e){var t,a,i=r.extend({},e);return t='<div class="youzify-attachment-item youzify-file-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i><span class="youzify-file-name">'+r.youzify_GetNameExcerpt(i.file_name)+'</span></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+i.input_name+'" /></div>',a='<div class="youzify-attachment-item youzify-image-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+i.input_name+'" /></div>',r.youzify_CheckIsFileImage(i.file)?a:t},r.youzify_UploadFile=function(n,o,f){var s=o.find(".youzify-file-progress:first").parent(".youzify-attachment-item"),e=new FormData;e.append("file",f),n.hasClass("youzify-wall-form")?(e.append("target","activity"),e.append("post_type",n.find('input:radio[name="post_type"]:checked').val())):n.hasClass("ac-form")?e.append("target","comment"):"send-reply"!=n.closest("form").attr("id")&&"send_message_form"!=n.closest("form").attr("id")||e.append("target","message"),e.append("attachments_number",n.find(".youzify-attachment-item").length),e.append("action","youzify_upload_wall_attachments"),e.append("security",Youzify.security_nonce),console.log(e),r.ajax({type:"POST",url:Youzify.ajax_url,data:e,cache:!1,contentType:!1,processData:!1,xhr:function(){var e=r.ajaxSettings.xhr();return e.upload&&(n.find(".youzify-wall-post,.youzify-update-post").attr("disabled",!0),e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.total,a=100*e.loaded/t,i=s.find(".youzify-file-upload");s.find(".youzify-file-icon").attr("class","fas fa-spinner fa-spin youzify-file-icon"),i.css("width",a+"%"),100<=a&&i.addClass("youzify-file-uploaded")}})),e},success:function(e){if(0==e.success)return r.youzify_DialogMsg("error",e.data.error),n.hasClass("ac-form")?n.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=n.attr("id")&&"send_message_form"!=n.attr("id")||n.find(".youzify-upload-btn").fadeIn(),s.remove(),r.youzify_CheckUploadProgress(n),!1;var t=e.data.base_url;s.find(".youzify-file-progress").fadeOut(400,function(){r(this).remove(),r.youzify_upload_next_file(n,o),r.youzify_CheckUploadProgress(n)}),r.youzify_CheckIsFileImage(f)&&s.find(".youzify-file-icon").remove(),s.find(".youzify-file-icon").attr("class","fas fa-paperclip youzify-file-icon"),s.find(".youzify-attachment-details").append('<i class="fas fa-trash-alt youzify-delete-attachment"></i>'),delete e.data.base_url,s.find(".youzify-attachment-data").val(JSON.stringify(e.data));var i=new FileReader;f.type.match("video.*")&&(i.onload=function(){var e=new Blob([i.result],{type:f.type}),n=URL.createObjectURL(e),o=document.createElement("video"),t=function(){a()&&(o.removeEventListener("timeupdate",t),o.pause())};o.addEventListener("loadeddata",function(){a()&&o.removeEventListener("timeupdate",t)});var a=function(){var e=document.createElement("canvas");e.width=o.videoWidth,e.height=o.videoHeight,e.getContext("2d").drawImage(o,0,0,e.width,e.height);var t=e.toDataURL("image/jpeg"),a=1e5<t.length;if(a){var i=JSON.parse(s.find(".youzify-attachment-data").val());i.video_thumbnail=t,s.find(".youzify-attachment-data").val(JSON.stringify(i)),URL.revokeObjectURL(n)}return a};o.addEventListener("timeupdate",t),o.preload="metadata",o.src=n,o.muted=!0,o.playsInline=!0,o.play()},i.readAsArrayBuffer(f)),s.css("background-image","url("+t+"temp/"+e.data.original+")")},error:function(e,t,a){s.remove(),r.youzify_DialogMsg("error",t),r.youzify_CheckUploadProgress(n),r.youzify_upload_next_file(n,o)}})},r.youzify_upload_next_file=function(e,t){a++,null!==n&&void 0!==n.files[a]&&r.youzify_UploadFile(e,t,n.files[a])},r(document).on("click",".youzify-delete-attachment",function(e){var t=r(this).closest("form");t.hasClass("ac-form")?t.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=t.attr("id")&&"send_message_form"!=t.attr("id")||t.find(".youzify-upload-btn").fadeIn(),r(this).closest(".youzify-attachments").find(".youzify-wall-item-upload").fadeIn();var a=r(this).closest(".youzify-attachment-item");if(a.find(".youzify-attachment-data").get(0)){var i=r.parseJSON(a.find(".youzify-attachment-data").val());r.youzify_DeleteAttachment(i.original)}a.remove()}),r.youzify_DeleteAttachment=function(e){var t=new FormData;t.append("attachment",e),t.append("security",Youzify.security_nonce),t.append("action","youzify_delete_wall_attachment"),r.ajax({type:"POST",data:t,url:ajaxurl,contentType:!1,processData:!1})},r.youzify_GetNameExcerpt=function(e){if(e.length<=25)return e;var t=25-"...".length,a=Math.ceil(t/2),i=Math.floor(t/2);return e.substr(0,a)+"..."+e.substr(e.length-i)},r.youzify_CheckIsFileImage=function(e){var t=e.type;return!(r.inArray(t,["image/gif","image/jpeg","image/png"])<0)},r.youzify_CheckUploadProgress=function(e){e.find(".youzify-file-progress")[0]||(e.find(".youzify-upload-attachments").val(""),e.find('.youzify-wall-actions button[type="submit"]').attr("disabled",!1),a=0,n=null)},r.youzify_CheckFilesNumber=function(e){var t=e.find('input:radio[name="post_type"]:checked').val();return"activity_photo"==t||"activity_slideshow"==t||!e.find(".youzify-attachment-item")[0]||(n=null,r.youzify_DialogMsg("error",Youzify_Wall.max_one_file),!1)},r.youzify_getUrlParameter=function(e,t){var a,i,n=e.split("&");for(i=0;i<n.length;i++)if((a=n[i].split("="))[0]===t)return void 0===a[1]||decodeURIComponent(a[1])}})}(jQuery);